---
title: "Статистика стран и их основных характеристик"
author: "Valery Andruynichev"
date: '16 nov 2017 year'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

В данной работе представлена статистика стран и их основных характеристик.

I. Для выполнения работы потребуются следующие пакеты:

```{r,message=FALSE,warning=FALSE}
library(ggplot2)  
library(reshape2) 
library(dplyr) 
library(nortest) 
library(moments) 
```

II. Данные для анализа использованны данные Всемирного Банка(World Bank)

Загрузка файла с данными
Указание пути к папке, где лежит файл с данными
```{r, echo=TRUE}
dir<-"D://GH//Country//"
```

Загрузка файла
```{r, echo=TRUE}
wb<-read.csv(paste(dir,'wb_econometrics.csv',sep=''),stringsAsFactors = FALSE)
```

Для простоты рабы с фалом перобразуем его в вертикальный формат
```{r}
wb<-melt(wb,id=colnames(wb)[1:4])
colnames(wb)[5]<-'Year'
wb$Year<-as.numeric(gsub('X','',as.character(wb$Year)))
```

III. Рассмотрим полученные данные:
1) Перечень стран
```{r}
unique(wb$Country.name)
```

2) Перечень индикаторов
```{r}
unique(wb$Indicator.Name)
```

Сумма пустых(NA) наблюдений по определенному индикатору на определенный год
```{r}
sum(is.na(wb%>%filter(Year==2016,Indicator.Name=='GDP per capita (current US$)')%>%select(value)))
```

IV. Построим и визуализируем данные по определенным показателям для выбранных стран за определенный период времени

Выберем страны: США, Норвегия, Япония, Китай, Российская Федерация
```{r}
countries<-c("United States","Norway","Japan","China","Kazakhstan","Russian Federation")
```

И выберем индикаторы: Рост ВВП (в %), ВВП на душу населения (в $ по курсу на выбранный год), Доходы от продажи нефти (в % от ВВП), Налоговые поступления (в % от ВВП)
```{r}
indicator<-c("GDP growth (annual %)",'GDP per capita (current US$)',"Oil rents (% of GDP)","Tax revenue (% of GDP)")
```

Создадим модель
```{r}
wb%>%filter((Country.name %in% countries)&(Indicator.Name %in% indicator)            &Year>2014&Year<2016)%>%select(Country.name,Indicator.Name,Year,value)
```
В полученной таблицы мы видим выбраные нами страны и их показатели за требуемый год.


V.Создадим модель времяного ряда по доходам от продажи нефти (в % от ВВП) для Росии с 1988г.

Создадим выборку данных из основного файла
```{r}
rus_growth<-wb%>%filter(Country.name=="Russian Federation",Indicator.Name=="Oil rents (% of GDP)",
                        Year>1988)%>%dplyr::select(Year,value)
rus_growth
```

Визуализируем дааные по России
```{r}
ggplot(data=rus_growth,aes(Year,value))+geom_line(linetype = "dashed")+xlab('')+ylab('%')+
  ggtitle(' Динамика показателя доходов от продажи нефти(в % от ВВП)')
```

По графику видно, что с 1998 по 200 годы был стремительный рост доходов от продажи нефти, после 2000 годов последовао боковое движение и после 2012 постоянный спад доходов от продажи нефти.

VI. Создадим набор данных стран по доходам от продажи нефти pf 2015 год, и ранжируем их по уменьшению этих доходов. Анализируем только 20 стран с самым большими доходами от продажи нефти
```{r}
df<-head(wb%>%filter
(Year==2015&Indicator.Name=="Oil rents (% of GDP)")%>%
arrange(desc(value)),20)
```
И визуализируем данные
```{r}
ggplot(data=df,aes(reorder(Country.name,value,desc),value))+geom_bar(stat = "identity",fill = "blue")+
  xlab('Страна')+ylab('% от ВВП')+ggtitle('Крупнейшие страны по доходам от продажи нефти(в % от ВВП) ')+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

По гистограмме видно, что самый большой доход у Кювейта 38,5%. Россия занимает 17-е масто в данном списке с результатом 5,6%

VII. Статистический анализ показателя: доходы от продажи нефти (в % от ВВП)

Создадим вспомагательную переменнуюотчищеную от пустых(NA) значений
```{r}
x<-na.omit(wb%>%filter(Year==2015,Indicator.Name=="Oil rents (% of GDP)")%>%dplyr::select(value))$value
```

Основные статистические показатели 
```{r}
summary(x)
```

Оценим коэффициенты асимметрии дохода от продажи нефти (в % от ВВП)
```{r}
skewness(x)
```
И эксцесса
```{r}
kurtosis(x)
```
Коэффициенты асимметрии и эксцесса показывают, что распределение смещено сильно влево и вверх в отличии от нормального распределения

А также проверим гипотезу о нормальном распределении тестом Пирсона и Андерсона-Дарлинга

```{r}
pearson.test(x) # Тест Пирсона
ad.test(x) # Тест Андерсона-Дарлинга
```

У обох тестов значение p-value ниже порогового 5%, следовательно "нулевая гипотеза(Н0)" от том, что рапределение показателя "доходы от продажи нефти (в % от ВВП)" соответствует нормальному распределению отвергается.

Построим гистограмму распределения доходов от продажи нефти (в % от ВВП)
Перед построением отчистим данные от пустых(NA) значение
```{r, message=FALSE,warning=FALSE}
x_df<-na.omit(wb%>%filter(Year==2015,Indicator.Name=="Oil rents (% of GDP)")%>%dplyr::select(value))
ggplot(data=x_df,aes(x_df$value))+geom_histogram()+xlab('')
```

По гистограмме видно, что распределение показателя не соответсвует нормальному распределению

Для привода распределение показателя к нормальному(логнормальному) распределению можно трансформировать натуральные показатели к логарифмическим 
```{r}
ln_x<-log(na.omit(wb%>%filter(Year==2015,Indicator.Name=="Oil rents (% of GDP)")%>%select(value))$value)
```


Основные статистические показатели 
```{r}
summary(ln_x)
```

Найдем интервальную оценку для математического распределения с помощью распределения Стьюдента, с доверитеьным интервалом 95%

```{r}
alpha<-0.05
error <- qt(1-alpha/2,df=length(ln_x)-1)*sd(ln_x)/sqrt(length(ln_x))
mean(ln_x)-error
mean(ln_x)+error
t.test
```

Значение p-value очень мало(2.2e-16), следовательно нулевая гипотеза(Н0) о том, что реальная дисперсия лежит за пределами расчетного интервала отвергается

Найдем интервальную оценку для дисперсии с 95% верояностью(используем $\chi^2$ распределение)

```{r}
df=length(ln_x)
chilower = qchisq((alpha/2), df)
chiupper = qchisq(alpha/2, df,lower.tail = FALSE)
#chiupper<-qchisq((1-alpha/2), df)
df*var(ln_x)/chiupper
```

Оценим коэффициенты асимметрии 
```{r}
skewness(ln_x)
```
И эксцесса
```{r}
kurtosis(ln_x)
```
Коэффициенты асимметрии и эксцесса показывают незначительное отклонение от нормального распределения

Проведем тесты
```{r}
pearson.test(x) # Тест Пирсона
ad.test(x) # Тест Андерсона-Дарлинга
shapiro.test(ln_x) # Тест Шапиро-Вилка
```


Построим гистограмму распредления трансформированных значений
```{r,message=FALSE,warning=FALSE}
x_df<-na.omit(wb%>%filter(Year==2015,Indicator.Name=="Oil rents (% of GDP)")%>%select(value))
x_df$value<-log(x_df$value)
ggplot(data=x_df,aes(x_df$value))+geom_histogram(fill='blue',bins=10)+xlab('')
```
По гистограмме мы видим, что распределение соответствует нормальному распределению


VIII. Для окончательной проверки соответсвтвия параметров (доходов от продажи нефти (в % от ВВП)) параметрам нормального распределения.

Сгенирируем случайненые нормальные величины с параметрами (доходов от продажи нефти (в % от ВВП)), и проведем тесты на соответствие параметров нобора сгенирированных случайных величин, параметрам нормального распределения

```{r}
y<-rnorm(length(ln_x),mean(ln_x),sd(ln_x))
```

Проверим сгенирированые величины на нормальности распределения

```{r}
pearson.test(x) # Тест Пирсона
ad.test(x) # Тест Андерсона-Дарлинга
```
p-value обоих тестов (0.59 и 0.24) показывают, что распределение случайных величин соответствует нормальному распределению

Построим гистограмму случайной величины

```{r}
# hist(y,main='Гистограмма биномиального закона распределения', ylab = 'Частота',breaks = "Sturges")
```
По гистограмме видно, что распределение соответствует нормальному распределению

Для сравнения сгенерируем случайную величину, распределенную по закону Пуассона (1000 наблюений, вероятность события 0.01)

```{r}
y_p<-rpois(1000,1000*.01)
hist(y_p,main='Гистограмма распределения Пуассона',ylab = 'Частота')
```

На гистограмме видно, что сгенерируемая случайная велисина совпадает с гистограммой (y)

Также построим гистограмму с биномиальным законом распределения

```{r}
y_b<-rbinom(100,5,0.4)
y_b 

hist(y_b,main='Гистограмма биномиального закона распределения',ylab = 'Частота')
```


IX. Проведм анализ фондового индекса

Загрузим данные фондового индекса SP500

```{r}
sp500<-read.csv(paste(dir,'^GSPC.csv',sep=''),stringsAsFactors = FALSE)
```

Переведем столбец с датой из текстового формата в формат даты

```{r}
sp500$Date<-as.Date(sp500$Date)
class(sp500$Date)
head(sp500)
```

Сократим срок наблюдение с 1 января 200г. 
```{r}
sp500<-sp500[sp500$Date>'1999-12-31',]
head(sp500)
```

Построим график для SP500

```{r}
ggplot(data=sp500,aes(Date,Adj.Close))+geom_line(color='red')+xlab('')+ylab(' ')+ggtitle(' Динамика индекса S&P500')
```

По графику видно, что SP500 преимущественно рос, особенно сильный рост заметен с 2009г.

Трансформируем данные в логарифм(дневные доходности)
```{r}
sp500_ln<-data.frame(Date=sp500$Date[-1],sp_ln=diff(log(sp500$Adj.Close),1))
head(sp500_ln)
tail(sp500_ln)
```

Просмотрем основные параметры распределения SP500_ln

```{r}
summary(sp500_ln)
```
Среднее значение показывает, что основная доходность индекса за 17 лет соответствовала 0.01%

Найдем стандартное отклонение SP500_ln

```{r}
sd(sp500_ln$sp_ln)
```

Стандартное отколенение незначительное (0.01)

Найдем коэффициенты асимметрии и эксцеса

```{r}
skewness(sp500_ln$sp_ln)
kurtosis(sp500_ln$sp_ln)
```

Коэффициенты показываюн незначительную асимметрию, но достаточно значительный эксцесс. Из этого следует, что медиана лежит достаточно близко к среднему значениию, и что распределение сильно вытянута вверх

Проведем тесты на соответствие параметров выборки параметрам нормального распределения
```{r}
pearson.test(sp500_ln$sp_ln)
shapiro.test(sp500_ln$sp_ln)
```

p-value<2.2e-16 тестов показывает, что нулевая гипотеза(Н0) о том, что распределение соответствует нормальному распределению отвергается 

```{r}
hist(sp500_ln$sp_ln)
```
На данной гистограме отчетливо видене достаточно большой эксцесс

```{r}
qqnorm(sp500_ln$sp_ln)
qqline(sp500_ln$sp_ln)
```
На графике видно, что значительная часть данных лежит в обасти нормального распределения
